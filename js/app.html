<script>
/**
 * ðŸš€ MAIN APPLICATION CONTROLLER
 */
class RaveOneLMS {
    constructor() {
        this.user = null;
        this.token = null;
        this.apiBase = 'https://script.google.com/macros/s/AKfycbwtFkwwQmQIJTsJSxfJP4RbPORlIPEItHjF1Lch2Ag_Ai3IAzyaI4kb7nqxX3Z3h8CG/exec';
    }
    
    async initApp() {
        console.log("App initializing...");
        this.token = localStorage.getItem('lms_token');
        
        if (this.token) {
            try {
                const response = await this.apiCall('auth/validate', {}, this.token);
                if (response && response.valid) {
                    this.user = response.user;
                    this.setupUI();
                    await this.loadView('dashboard');
                    return;
                }
            } catch (error) {
                console.warn('Session expired.');
            }
        }
        
        if (typeof showLogin === 'function') {
            showLogin();
        }
    }

    setupUI() {
        const nameEl = document.querySelector('.user-name');
        if (nameEl && this.user) nameEl.textContent = this.user.name;
    }

    async loadView(view) {
        const area = document.getElementById('contentArea');
        area.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Loading...</p></div>';
        
        try {
            const data = await this.apiCall('dashboard/summary', {}, this.token);
            area.innerHTML = `
                <div class="dashboard">
                    <div class="card">
                        <div class="card-body">
                            <h3>Welcome, ${this.user.name}</h3>
                            <div class="row">
                                <div class="col-3"><b>${data.activeCourses}</b> Active Courses</div>
                                <div class="col-3"><b>${data.pendingAssignments}</b> Pending Tasks</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        } catch (e) {
            area.innerHTML = '<div class="alert alert-danger">Error loading data.</div>';
        }
    }

    async apiCall(endpoint, data = {}, token = null) {
        const response = await fetch(this.apiBase, {
            method: 'POST',
            body: JSON.stringify({ endpoint, data, token })
        });
        return await response.json();
    }

    async login(email, password) {
        const res = await this.apiCall('auth/login', { email, password });
        if (res.success) {
            this.user = res.user;
            this.token = res.token;
            localStorage.setItem('lms_token', this.token);
            this.setupUI();
            this.loadView('dashboard');
            return { success: true };
        }
        return { success: false, error: res.error };
    }

    logout() {
        localStorage.clear();
        location.reload();
    }
}

// Global instance and hooks
const app = new RaveOneLMS();
function initApp() { app.initApp(); }
function loadDashboard() { app.loadView('dashboard'); }
function logout() { app.logout(); }
</script>
